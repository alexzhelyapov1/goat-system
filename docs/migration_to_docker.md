# Миграция с non-Docker на Docker с сохранением БД

Этот документ описывает пошаговый процесс переноса приложения с существующей SQLite базой данных в Docker-окружение без потери данных.

## Шаг 0: Подготовка

Перед началом миграции необходимо выполнить несколько подготовительных шагов на вашем сервере.

### 1. Сделайте резервную копию

Это **самый важный** шаг. Создайте копию вашего файла с базой данных и положите ее в безопасное место за пределами папки проекта.

```bash
# Пример:
# cp /путь/к/старому/проекту/data.db /home/user/db_backup.db
```

### 2. Остановите старое приложение

Чтобы избежать повреждения данных во время копирования, полностью остановите ваше текущее приложение. Если оно работает как systemd сервис:

```bash
# sudo systemctl stop your_app_name.service
```

Или используйте `kill`, если вы запускали его вручную.

### 3. Разместите новый код

Загрузите или склонируйте новую версию вашего проекта (которая содержит `Dockerfile` и `docker-compose.yml`) на сервер.

---

## Шаг 1: Процесс миграции данных

Теперь, когда все готово, мы можем начать перенос данных.

### 1. Перейдите в директорию проекта

Откройте терминал и перейдите в папку с новым кодом вашего проекта.

```bash
# cd /путь/к/новому/проекту/
```

### 2. Создайте Docker Volume

Нам нужно, чтобы Docker создал именованный volume, куда мы поместим базу данных. Лучший способ сделать это — выполнить команду `docker-compose up` со специальным флагом, который только создает ресурсы, но не запускает их.

```bash
docker-compose up --no-start
```

Эта команда создаст volume. Его имя будет состоять из имени папки проекта и имени volume из `docker-compose.yml`, например: `goat-system_sqlite_data`. Вы можете проверить список всех volumes командой `docker volume ls`.

### 3. Скопируйте базу данных в Volume

Это ключевой шаг. Мы запустим временный легковесный контейнер (`alpine`), который "видит" и папку со старой базой данных, и новый Docker Volume, и скопируем файл из одного места в другое.

Выполните следующую команду, **заменив пути-плейсхолдеры на ваши**:

```bash
docker run --rm \
  -v /ПУТЬ/К/ПАПКЕ/СО/СТАРОЙ/БД:/source_data \
  -v ИМЯ_ПРОЕКТА_sqlite_data:/target_data \
  alpine sh -c "cp /source_data/ИМЯ_ФАЙЛА_БД.db /target_data/"
```

**Пример заполнения:**

*   `/ПУТЬ/К/ПАПКЕ/СО/СТАРОЙ/БД` — например, `/home/alex/mipt/goat-system-old/data`
*   `ИМЯ_ПРОЕКТА_sqlite_data` — например, `goat-system_sqlite_data` (узнать можно через `docker volume ls`)
*   `ИМЯ_ФАЙЛА_БД.db` — например, `app.db`

**Готовый пример команды:**

```bash
docker run --rm \
  -v /home/alex/mipt/goat-system-old/data:/source_data \
  -v goat-system_sqlite_data:/target_data \
  alpine sh -c "cp /source_data/app.db /target_data/"
```

### 4. (Опционально) Проверьте результат

Вы можете убедиться, что файл успешно скопирован, запустив другой временный контейнер и посмотрев содержимое volume.

```bash
docker run --rm -v ИМЯ_ПРОЕКТА_sqlite_data:/data alpine ls -l /data
```

Вы должны увидеть ваш файл базы данных в выводе.

---

## Шаг 2: Запуск нового приложения

Теперь, когда данные на месте, можно запускать приложение.

### 1. Запустите Docker-контейнеры

Находясь в папке проекта, выполните:

```bash
docker-compose up -d --build
```

*   `--build` — пересоберет образ вашего приложения с последними изменениями в коде.
*   `-d` — запустит контейнеры в фоновом режиме (detached).

### 2. Проверьте логи

Убедитесь, что все сервисы запустились корректно, проверив их логи.

```bash
docker-compose logs -f web
# или
docker-compose logs -f bot
```

Если вы не видите ошибок, а в логах `web` сервиса есть строки от gunicorn о запущенных воркерах, значит, миграция прошла успешно. Ваше приложение теперь работает в Docker и использует старую базу данных.

```