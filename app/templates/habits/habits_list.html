{% extends "base.html" %}

{% block content %}
    <h1>Habits</h1>
    <a href="#" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#habitModal" data-habit-id="create">Create Habit</a>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Habit</th>
                {% for dt in dates %}
                    <th scope="col" class="{% if dt == today %}table-primary{% endif %}">{{ dt.strftime('%a') }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for item in habits_with_logs %}
                <tr>
                    <td><a href="#" data-bs-toggle="modal" data-bs-target="#habitModal" data-habit-id="{{ item.habit.id }}">{{ item.habit.name }}</a></td>
                    {% for date, is_done in item.logs.items() %}
                        <td class="{% if date == today %}table-primary{% endif %}">
                            {% if item.habit.strategy_type == 'weekly' and item.habit.strategy_params and 'days' in item.habit.strategy_params %}
                                {% if date.weekday() in item.habit.strategy_params['days'] %}
                                    <input class="form-check-input" type="checkbox" value=""
                                           {% if is_done %}checked{% endif %}
                                           onchange="logHabit('{{ item.habit.id }}', '{{ date.isoformat() }}', this.checked)">
                                {% endif %}
                            {% elif is_done is sequence and not is_done is string %}
                                {% for i in range(is_done|length) %}
                                    <input class="form-check-input" type="checkbox" value=""
                                           {% if is_done[i] %}checked{% endif %}
                                           onchange="logHabit('{{ item.habit.id }}', '{{ date.isoformat() }}', this.checked, {{ i }})">
                                {% endfor %}
                            {% else %}
                                <input class="form-check-input" type="checkbox" value=""
                                       {% if is_done %}checked{% endif %}
                                       onchange="logHabit('{{ item.habit.id }}', '{{ date.isoformat() }}', this.checked)">
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="habitModal" tabindex="-1" aria-labelledby="habitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="habitModalLabel">Edit Habit</h5>
                    <a href="#" id="full-page-edit-link" class="btn btn-secondary ms-auto">Expand</a>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="" method="post" novalidate id="habit-modal-form">
                        {% include 'habits/_habit_form.html' %}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="delete-habit-btn" class="btn btn-danger me-auto">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="habit-modal-form" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

<script>
function logHabit(habitId, date, isDone, index = null) {
    const form = new FormData();
    form.append('habit_id', habitId);
    form.append('date', date);
    form.append('is_done', isDone);
    if (index !== null) {
        form.append('index', index);
    }

    fetch("{{ url_for('habits.log_habit') }}", {
        method: 'POST',
        body: form
    }).then(response => {
        if (!response.ok) {
            alert('Failed to log habit');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    var habitModal = document.getElementById('habitModal');
    var currentHabitId;
    var deleteHabitBtn = document.getElementById('delete-habit-btn');
    habitModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var habitId = button.getAttribute('data-habit-id');
        currentHabitId = habitId;
        var modalTitle = habitModal.querySelector('.modal-title');
        var form = habitModal.querySelector('#habit-modal-form');
        var fullPageEditLink = document.getElementById('full-page-edit-link');

        if (habitId === 'create') {
            modalTitle.textContent = 'Create Habit';
            form.action = '{{ url_for("habits.create_habit") }}';
            fullPageEditLink.href = '{{ url_for("habits.create_habit") }}';
            form.reset();
            deleteHabitBtn.style.display = 'none';
        } else {
            deleteHabitBtn.style.display = 'block';
            // Set the title and form action
            modalTitle.textContent = 'Edit Habit ' + habitId;
            form.action = '/habits/edit/' + habitId;
            fullPageEditLink.href = '/habits/edit/' + habitId;

            // Fetch habit data and populate the form
            fetch('/habit/' + habitId + '/json')
                .then(response => response.json())
                .then(data => {
                    form.name.value = data.name;
                    form.description.value = data.description;
                    form.start_date.value = data.start_date ? data.start_date.substring(0, 10) : '';
                    form.end_date.value = data.end_date ? data.end_date.substring(0, 10) : '';
                    form.strategy_type.value = data.strategy_type;
                    form.strategy_params.value = JSON.stringify(data.strategy_params);
                });
        }
    });
});
</script>
{% endblock %}
