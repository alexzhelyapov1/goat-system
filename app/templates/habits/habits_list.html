{% extends "base.html" %}

{% block content %}
    <h1>Habits</h1>
    <a href="#" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#habitModal" data-habit-id="create">Create Habit</a>
    <table class="table">
        <thead id="habit-table-header">
            <tr>
                <th scope="col">Habit</th>
                <!-- Dates will be populated by JavaScript -->
            </tr>
        </thead>
        <tbody id="habits-list-body">
            <!-- Habits will be populated by JavaScript -->
        </tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="habitModal" tabindex="-1" aria-labelledby="habitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="habitModalLabel">Edit Habit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="" method="post" novalidate id="habit-modal-form">
                        {% include 'habits/_habit_form.html' %}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="delete-habit-btn" class="btn btn-danger me-auto">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="habit-modal-form" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

<script>
        // Helper function to get auth headers
        function getAuthHeaders() {
            if (window.jwt_token) {
                return {
                    'Authorization': `Bearer ${window.jwt_token}`,
                    'Content-Type': 'application/json'
                };
            }
            return {'Content-Type': 'application/json'};
        }

        async function logHabit(habitId, date, isDone, index = 0) { // Default index to 0
            if (!window.jwt_token) {
                alert("Authentication token not available. Please log in again.");
                return;
            }

            const payload = {
                habit_id: parseInt(habitId),
                date: date, // ISO format string
                is_done: isDone,
                index: index
            };

            try {
                const response = await fetch(`/api/habits/${habitId}/log`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to log habit: ${JSON.stringify(errorData)}`);
                }
                // Optionally refresh the table after logging
                // fetchHabitsAndRenderTable();
            } catch (error) {
                console.error("Error logging habit:", error);
                alert('Error logging habit.');
            } finally {
                fetchHabitsAndRenderTable(); // Always refresh the table after a log attempt
            }
        }

        async function fetchHabitsAndRenderTable() {
            if (!window.jwt_token) {
                console.warn("JWT not available. Cannot fetch habits.");
                return;
            }

            const habitTableHeader = document.getElementById('habit-table-header');
            const habitsListBody = document.getElementById('habits-list-body');
            habitsListBody.innerHTML = '<tr><td colspan="8">Loading habits...</td></tr>'; // Placeholder

            try {
                // 1. Fetch habits
                const habitsResponse = await fetch('/api/habits', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                if (!habitsResponse.ok) {
                    throw new Error(`Failed to fetch habits: ${habitsResponse.statusText}`);
                }
                const habits = await habitsResponse.json();

                // 2. Determine date range (current week, Monday to Sunday)
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Adjust for Monday start
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                const dates = [];
                for (let d = new Date(startOfWeek); d <= endOfWeek; d.setDate(d.getDate() + 1)) {
                    dates.push(new Date(d)); // Push a new date object to avoid reference issues
                }

                // 3. Render table header with dates
                let headerRow = '<tr><th scope="col">Habit</th>';
                dates.forEach(dt => {
                    const formattedDate = dt.toLocaleDateString('en-US', { weekday: 'short' }); // e.g., Mon
                    const dateString = dt.toISOString().split('T')[0]; // YYYY-MM-DD
                    const isToday = dt.toDateString() === today.toDateString();
                    headerRow += `<th scope="col" class="${isToday ? 'table-primary' : ''}" data-date="${dateString}">${formattedDate}</th>`;
                });
                headerRow += '</tr>';
                habitTableHeader.innerHTML = headerRow;

                // 4. Fetch logs for each habit and render table body
                habitsListBody.innerHTML = ''; // Clear loading message

                if (habits.length === 0) {
                    habitsListBody.innerHTML = '<tr><td colspan="8" class="text-center">No habits found.</td></tr>';
                    return;
                }

                for (const habit of habits) {
                    const logsResponse = await fetch(`/api/habits/${habit.id}/logs?start_date=${startOfWeek.toISOString().split('T')[0]}&end_date=${endOfWeek.toISOString().split('T')[0]}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });

                    if (!logsResponse.ok) {
                        console.error(`Failed to fetch logs for habit ${habit.id}: ${logsResponse.statusText}`);
                        continue; // Skip this habit if logs can't be fetched
                    }
                    const logs = await logsResponse.json();
                    const logsByDate = {};
                    logs.forEach(log => {
                        const logDate = log.date; // YYYY-MM-DD string
                        if (!logsByDate[logDate]) {
                            logsByDate[logDate] = {};
                        }
                        logsByDate[logDate][log.index] = log.is_done;
                    });

                    let habitRow = `<tr>
                        <td><a href="#" data-bs-toggle="modal" data-bs-target="#habitModal" data-habit-id="${habit.id}">${habit.name}</a></td>`;

                    dates.forEach(dt => {
                        const dateString = dt.toISOString().split('T')[0];
                        const logForDate = logsByDate[dateString];
                        const isToday = dt.toDateString() === today.toDateString();
                        habitRow += `<td class="${isToday ? 'table-primary' : ''}">`;

                        // Render checkboxes based on strategy type
                        if (habit.strategy_type === 'daily' && habit.strategy_params && habit.strategy_params.frequency > 1) {
                            for (let i = 0; i < habit.strategy_params.frequency; i++) {
                                const isDone = logForDate && logForDate[i] !== undefined ? logForDate[i] : false;
                                habitRow += `<input class="form-check-input" type="checkbox" value=""
                                           ${isDone ? 'checked' : ''}
                                           onchange="logHabit(${habit.id}, '${dateString}', this.checked, ${i})">`;
                            }
                        } else if (habit.strategy_type === 'weekly' && habit.strategy_params && habit.strategy_params.days) {
                            const dayOfWeekNum = dt.getDay(); // 0-6, Sunday-Saturday
                            const apiDayOfWeek = dayOfWeekNum === 0 ? 6 : dayOfWeekNum - 1; // Convert to Monday=0, Sunday=6
                            if (habit.strategy_params.days.includes(apiDayOfWeek)) {
                                const isDone = logForDate && logForDate[0] !== undefined ? logForDate[0] : false; // Weekly only has one log per day
                                habitRow += `<input class="form-check-input" type="checkbox" value=""
                                           ${isDone ? 'checked' : ''}
                                           onchange="logHabit(${habit.id}, '${dateString}', this.checked, 0)">`;
                            }
                        } else {
                            // Default case for single checkbox (daily frequency 1 or other types)
                            const isDone = logForDate && logForDate[0] !== undefined ? logForDate[0] : false;
                             habitRow += `<input class="form-check-input" type="checkbox" value=""
                                           ${isDone ? 'checked' : ''}
                                           onchange="logHabit(${habit.id}, '${dateString}', this.checked, 0)">`;
                        }
                        habitRow += `</td>`;
                    });
                    habitRow += '</tr>';
                    habitsListBody.innerHTML += habitRow;
                }

            } catch (error) {
                console.error("Error fetching habits and logs:", error);
                habitsListBody.innerHTML = `<tr><td colspan="8" class="alert alert-danger">Error loading habits: ${error.message}</td></tr>`;
            }
        }

        // Expose to global scope for debugging
        window.fetchHabitsAndRenderTable = fetchHabitsAndRenderTable;


        var habitModal = document.getElementById('habitModal');
        var currentHabitId;
        var deleteHabitBtn = document.getElementById('delete-habit-btn');
        habitModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var habitId = button.getAttribute('data-habit-id');
            currentHabitId = habitId;
            var modalTitle = habitModal.querySelector('.modal-title');
            var form = habitModal.querySelector('#habit-modal-form');
            var fullPageEditLink = document.getElementById('full-page-edit-link');

            if (habitId === 'create') {
                modalTitle.textContent = 'Create Habit';
                form.action = ''; // Will be handled by fetch
                fullPageEditLink.href = '#';
                form.reset();
                deleteHabitBtn.style.display = 'none';
            } else {
                deleteHabitBtn.style.display = 'block';
                // Set the title and form action
                modalTitle.textContent = 'Edit Habit ' + habitId;
                form.action = ''; // Will be handled by fetch


                // Fetch habit data and populate the form
                fetch(`/api/habits/${habitId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch habit: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        form.name.value = data.name;
                        form.description.value = data.description;
                        form.start_date.value = data.start_date ? data.start_date.substring(0, 10) : '';
                        form.end_date.value = data.end_date ? data.end_date.substring(0, 10) : '';
                        form.strategy_type.value = data.strategy_type;
                        form.strategy_params.value = JSON.stringify(data.strategy_params);
            })
            .catch(error => {
                console.error("Error fetching habit data:", error);
                alert('Error loading habit data.');
            });
        });

        // Handle form submission (Create/Update)
        const habitModalForm = document.getElementById('habit-modal-form');
        habitModalForm.addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent default form submission

            if (!window.jwt_token) {
                alert("Authentication token not available. Please log in again.");
                return;
            }

            const formData = new FormData(habitModalForm);
            const habitData = Object.fromEntries(formData.entries());

            // Ensure start_date and end_date are correctly formatted (YYYY-MM-DDTHH:MM:SS)
            // If date input is empty, it will be an empty string, which should result in null.
            const payload = {
                name: habitData.name,
                description: habitData.description || null,
                start_date: habitData.start_date ? `${habitData.start_date}T00:00:00` : null,
                end_date: habitData.end_date ? `${habitData.end_date}T00:00:00` : null,
                strategy_type: habitData.strategy_type,
                strategy_params: JSON.parse(habitData.strategy_params || '{}')
            };

            let url = '/api/habits';
            let method = 'POST';

            if (currentHabitId !== 'create') {
                url = `/api/habits/${currentHabitId}`;
                method = 'PUT';
            }
            console.log(`Submitting habit form: URL=${url}, Method=${method}, Payload=`, payload);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to save habit: ${JSON.stringify(errorData)}`);
                }

                // Habit saved successfully, close modal and refresh list
                const bsModal = bootstrap.Modal.getInstance(habitModal);
                bsModal.hide();
                fetchHabitsAndRenderTable();
            } catch (error) {
                console.error("Error saving habit:", error);
                alert(`Error saving habit: ${error.message}`);
            }
        });

        // Handle delete habit button click
        deleteHabitBtn.addEventListener('click', async function() {
            if (!confirm('Are you sure you want to delete this habit?')) {
                return;
            }

            if (!window.jwt_token) {
                alert("Authentication token not available. Please log in again.");
                return;
            }

            try {
                const response = await fetch(`/api/habits/${currentHabitId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to delete habit: ${JSON.stringify(errorData)}`);
                }

                // Habit deleted successfully, close modal and refresh list
                const bsModal = bootstrap.Modal.getInstance(habitModal);
                bsModal.hide();
                fetchHabitsAndRenderTable();
            } catch (error) {
                console.error("Error deleting habit:", error);
                alert(`Error deleting habit: ${error.message}`);
            }
        });

        // Initial fetch of habits when the page loads, after JWT is ready
        if (window.jwt_token) {
            fetchHabitsAndRenderTable();
        } else {
            document.addEventListener('jwt-ready', fetchHabitsAndRenderTable);
        }
</script>
{% endblock %}
